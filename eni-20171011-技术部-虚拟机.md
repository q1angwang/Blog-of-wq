# 关于虚拟机(win下)

<link rel="stylesheet" href="http://yandex.st/highlightjs/6.2/styles/googlecode.min.css">
<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
<script src="http://yandex.st/highlightjs/6.2/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
 $(document).ready(function(){
 $("h2,h3,h4,h5,h6").each(function(i,item){
 var tag = $(item).get(0).localName;
 $(item).attr("id","wow"+i);
 $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
 $(".newh2").css("margin-left",0);
 $(".newh3").css("margin-left",20);
 $(".newh4").css("margin-left",40);
 $(".newh5").css("margin-left",60);
 $(".newh6").css("margin-left",80);
 });
 });
</script>
<div id="category"></div>









## 需求来源：
许多渗透、逆向书籍的第一章，装虚拟机//渗透环境的搭建
wireshark抓包分析
搭建LAMP 自己日自己

## 预备：
* vm12下好 软件 去官方下载 支持正版 vm12的激活码


* 准备好U盘拷贝 注意拷贝 



### 虚拟化：

工作原理

虚拟化基础知识

x86设计局限性，每次只能运行一个操作系统和应用；单台服务器若固定使用，利用率低

优势：
1. 分区(多个操作系统 分配系统资源) 
2. 隔离(硬件级别进行故障和安全隔离) 
3. 封装(将虚拟机的完整状态可以保存 移动复制轻松)
4. 独立于硬件

refer ——[《再聊聊虚拟化那些事》](http://www.eflybird.com/news_detail.php?id=1048)



#### BIOS开启虚拟化：

进bios：[F1]、[F2]、[F10]、[ESC]、开机不断回车




#### 硬件层面支持64位

运行 64 位虚拟机只靠vm无法模拟，需要硬件支持虚拟化。

Intel CPU 要求芯片和 BIOS 支持 EM64T 和 VT，包括：  
Intel 虚拟化技术  
Intel 64 位扩展内存技术  
Execute Disable Bit 病毒防护技术  

Microsoft 提供硬件辅助虚拟化检测工具。有关详细信息，请参见 Microsoft Download Center。

可在 Intel Website 上查看电脑硬件处理器的兼容性
<http://ark.intel.com/Products/VirtualizationTechnology>

#### [vmware的硬件选项里有关于虚拟化引擎的选项](http://blog.csdn.net/qq_32907349/article/details/51491555)
[?]禁用二进制转换加速(D)   
[?]虚拟化 Intel VT-x/EPT 或 AMD-VRVI(V)
[?]虚拟化CPU性能计数器(U)
[IBM虚拟化漫谈](https://www.ibm.com/developerworks/cn/linux/l-cn-vt/)一文中这样介绍Intel VT-x/EPT技术：

    硬件辅助虚拟化（Hardware-Assisted Virtualization） 
    硬件辅助虚拟化是指借助硬件（主要是主机处理器）的支持来实现高效的全虚拟化。例如有了 Intel-VT 技术的支持，Guest OS 和 VMM 的执行环境自动地完全隔离开来，Guest OS 有自己的“全套寄存器”，可以直接运行在最高级别。因此在上面的例子中，Guest OS 能够执行修改页表的汇编指令。Intel-VT 和 AMD-V 是目前 x86 体系结构上可用的两种硬件辅助虚拟化技术。


1. Intel VT-x/EPT和AMD-V/RVI(V)
* Intel VT-X技术实现的功能是减少虚拟机运行时虚拟机和物理机得到双重系统调用所产生的高Context Switch。也就是说，虚拟机的进程在要先从虚拟机ring3转到ring0，再从物理机的ring3转到ring0，性能有很大损失，而Intel VT-X就是为了解决这一问题而产生的技术。

* Intel RPT技术则是为了解决虚拟机的虚拟内存映射问题。虚拟机的虚拟内存要映射到虚拟机的物理内存上面，而虚拟机的物理内存相当于物理机的虚拟内存，物理机的虚拟内存也是要映射到物理机的物理内存上面的，所以这双重转换会造成很大的资源消耗，RPT技术就是减小这个消耗的。

// AMD实现的功能和Intel的功能类似



2. 虚拟化cpu性能计数器
CPU 性能监控计数器 (PMC) 为软件提供了一种监控和衡量处理器性能的方法。这些计数器通常由诸如软件探查器等工具使用。从具有 ESX 5.1 及更高版本兼容性（硬件软件 9）的虚拟机开始，可以启用虚拟性能监控计数器 (vPMC) 功能以允许在虚拟机中运行的软件访问此性能信息，如在物理机中运行一样。    
启用虚拟 CPU 性能监控计数器后，以下 MSR 会虚拟化并可用于客户机操作系统。

    Intel CPU 
    IA32_PERFEVTSELx 
    IA32_PMCx IA32_FIXED_CTRx 
    IA32_PERF_GLOBAL_CTRL 
    IA32_PERF_GLOBAL_STATUS 
    IA32_PERF_GLOBAL_OVF_CTRL 
    IA32_FIXED_CTR_CTRL

    AMD CPU 
    PERF_CTLx 
    PERF_CTRx
[vmware官网](https://kb.vmware.com/s/article/2101737)上有关于vmware的“虚拟化cpu性能计数器”功能的详细介绍。


3. 禁用二进制转换加速

vmware workstation 的官方帮助文档是这样说明的：

    在个别情况下，您可能会发现在虚拟机中安装或运行软件时，Workstation Pro呈现出冻结状态。这个问题通常出现在程序执行初期。在很多情况下，在虚拟机中临时禁用加速功能即可避免此问题。当程序度过问题多发阶段后，可取消选中该设置。



## 安装：
安装中遇到问题，多百度 


安装VMware Tools
//如果没有安装Vm-Tools的话，一部分功能将得不到充分应用，如显卡，鼠标不能够在虚拟机和物理机间自由移动等功能。
1. apt-get install open-vm-tools
2. vm安装tools，装载光盘(注意不要与原来的安装镜像冲突)

    $ tar zxvf VMwareTools-9.9.0-2304977.tar.gz
    $ cd vmware-tools-distrib/
    $ sudo ./vmware-install.pl
看到enjoy即安装成功


系统 内核 
vmtools


网络拓扑 [张师傅の文章](http://www.k0rz3n.com/2017/10/27/VMware%20%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E4%BB%A5%E5%8F%8A%E4%B8%89%E7%A7%8D%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%8B%93%E6%89%91%E5%88%86%E6%9E%90/)

VMware Network AdapterVMnet1
VMware Network AdapterVMnet8




## 遇到问题：
但Intel VT-x 处于禁用状态，开即可
vmware键盘挂钩超时，可忽略？
[VMWare下扩展Linux硬盘空间](http://blog.csdn.net/skywalker_only/article/details/16340861)

### 虚拟机文件迁移
vmware移动后 我已复制该虚拟机 不要用default，否则网络配置等跟随复制前的配置。

vm复制后开关错误 ，可以把错误文件(日志)删除 重启 ；思路同idle 删掉错误文件；  
即删掉虚拟机启动文件后重启试一下

报错提示VMware player cannot connect to the virtual machine. Make sure you have the rights to run the program. ： 
A. 右击我的电脑，点击管理   
B. 左侧看到服务与应用，点击服务双击，出来一串的服务找到VMware   authorization service，然后右击点属性   
C. 属性弹出后，属性弹出后启动类型选择自动，服务状态下面点击启动，就可以看到已经在运行，可继续刚才的操作了。  








### 网络问题：
1. 可以重启vm系统服务 / 重置虚拟网络编辑器 
2. 检查windows系统的VMsare DHCP Service和VMware NAT Service两个服务是否开启

    win+r services.msc


#### [解决VMware NAT service服务无法启动或服务消失的问题](https://blog.straywarrior.com/105.html)
今日使用VMware中的Windows 7虚拟机（NAT模式）发现没有网络，网卡显示“网络电缆已拔出”，检查之后发现宿主机的VMware NAT service服务没有启动，手动启动弹出错误提示“1067：进程意外终止”。

由于昨日刚升级宿主机的系统，猜想可能由于某些原因破坏了某些服务的依赖文件，如果是这样可能必须重装VMware才能解决。经过一些尝试之后，找到了不需要重装VMware的解决方法：

打开VMware的虚拟网络编辑器，选择“还原默认设置”，这时它会自动删除所有的VMware网络服务和虚拟网卡并且重新安装服务。如果操作完之后VMware NAT service消失了，就再进行一次“还原默认设置”，应该能解决问题。

还原默认设置之后，VMware NAT的子网IP和DHCP设置会发生变化，如果之前有IP相关的设置（比如端口转发），则使用虚拟网络编辑器重新设置子网的IP段即可。


#### [主机 ping 不通虚拟机，虚拟机可以ping通主机。解决方案。（ssh连接、linux、vmware）](http://www.programgo.com/article/41972829399/;jsessionid=CE67BA5747044E29E2B0C6B2E7EDEA1D)

 1、检查防火墙状态 并关闭。
 
     # /etc/init.d/iptables status  
     或
     # service iptables status
     # service iptables stop 关闭防火墙
 2、检查ssh 服务状态，启动服务。
  service sshd start
 
 纠结：防火墙关闭了，ssh服务启动， VMware 里网络适配器里的三种模式下 PC 无法 Ping 通虚拟机，

 解决：
360开启了`流量防火墙服务`，导致无法ping通


#### shadowsock
虚拟机虽然和主机共用网卡，ip，但是各自有各自的域名解析。所以并不是主机用了shadowsocks，虚拟机也用了，你在虚拟机也用shadowsocks就可以了。

ss只是个网页proxy，确实一般只用于网页代理，但是ss自己的功能很多，再与其他工具配合比如（proxifier、genpac等）能够比VPN更加灵活的全局科学上网。

在宿主机windows上运行shadowsocks.exe并勾选“允许局域网连接”  
使用桥接方式运行虚拟机（这时虚拟机与宿主处于同一个局域网）  
进入ubuntu系统，System Settings – Network – Network proxy勾选Manual（手动）,地址全部填宿主机IP（局域网网段），设置好代理端口（可在windows下的shadowsocks查看，一般为默认1080）  
ubuntu用浏览器访问www.google.com，成功

原理总结：  
默认的guest网络一般是NAT，改成桥接（bridge）让guest和host同处一个局域网，可用ss的局域网代理功能。






### 复制文件
即使装了vmtools / 增强功能，虚拟机的各个版本复制多个文件/文件夹会存在复制不全，在复制时尤其注意。可能问题：虚拟机所用的系统不兼容 / vmtools版本。
**解决**：
    1.共享文件夹比较稳(得配置)
    2.复制多个之前，先压缩
    3.NAS / FTP
    4.邮箱，qq邮箱；网盘
    5.实体 linux 大法好




安装VMware Tools
1. apt-get install open-vm-tools
2. vm安装tools，装载光盘(注意不要与原来的安装镜像冲突)

    $ tar zxvf VMwareTools-9.9.0-2304977.tar.gz
    $ cd vmware-tools-distrib/
    $ sudo ./vmware-install.pl
看到enjoy即安装成功，reboot生效//?


系统 内核 
vmtools


网络拓扑 [张师傅の文章](http://www.k0rz3n.com/2017/10/27/VMware%20%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E4%BB%A5%E5%8F%8A%E4%B8%89%E7%A7%8D%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%8B%93%E6%89%91%E5%88%86%E6%9E%90/)









## Tips：

* 多备份：  
克隆虚拟机 直接创建一万个虚拟机
全部都要有快照！！！！！！！！！！！！！！！！


* ubuntu的i386平台和amd64平台区别？  
i386：32位的ubuntu  
amd64：64位的ubuntu
不要以为i386只能用于intel的cpu，amd64只能用于amd的cpu。别被字面意思所迷惑。

* 官方文档
vm做的生意 去看官方pdf
<https://www.vmware.com/support/pubs/ws_pubs.html>
<https://docs.vmware.com/cn/VMware-Workstation-Pro/index.html>

* 遇到实体机环境时适应
在图形界面和文本界面间切换：  
     Ctrl+Alt+F(n) , 其中F(n)为F1-F6 ，为6个控制台；    
     Ctrl+ALT+F7 ；图形界面
     默认VM占用Ctrl+Alt为热键，所以由图形界面切换到文本界面的组合键为：Ctrl+Alt+Shift+F(n) 


* 重启大法好

* win下，看下`服务`，服务中的VMware的相关服务是否正常。


* 尝试了macOS，没有触控板配合并不舒畅。